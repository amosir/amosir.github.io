---
title: "BTC04 比特币系统实现"
date: 2020-06-10T13:46:12+08:00
draft: false
image: ""
categories: 
tag:
---


> 整理自 [北京大学肖臻老师《区块链技术与应用》公开课](https://www.bilibili.com/video/BV1Vt411X7JF?from=search&seid=14488407572640514229)



### 基于交易的账本模式

比特币采用的是**基于交易的账本模式**( transaction-based ledger) 。每个区块中记录的是交易信息(转账交易，铸币交易)，但是没有记录某个账户中有多少钱，需要根据交易记录去推算。区块链中一共有多少往某账户的地址转账的交易，转入多少币，这些币中又有多少被花掉，从而推算出余额。

比特币系统中全节点要维护一个**UTXO**的数据结构(Unspent Transaction Output)。区块链上有很多交易，有些交易的输出已经被花掉了，有些还没有被花掉，还没被花掉的交易的输出组成的集合就是UTXO。一个交易可能有多个输出，如下：

```
A--->B(5BTC) [B花掉了，不在UTXO中]         B--->D(5BTC)   [D还没花掉，在UTXO中]
  |
  |
  C(3BTC)  [在UTXO中]
```

采用UTXO是为了检测`double spending`。想要花掉的币必须在这个集合中才是合法的，如果不在集合中，那么币要么不存在，要么被花过。全节点要在内存中维护UTXO结构以便快速检测`double spending`



每个交易会消耗一些UTXO输出，也会产生新的输出。每个交易可以有多个输入，也可以有多个输出。所有输入的金额要等于所有输出的金额，即 total inputs = total outputs。有些交易会出现input > output，那么这个差额就是作为交易费给获得记账权的节点。



**比特币系统的激励机制**：1.block reward     2.transaction fee(这也是为什么获得记账权的节点会打包别人的交易)

目前来说，获得记账权的目的还是为了得到block reward，但是这个奖励每21万个区块会减半，大概是4年时间

[$\frac{21w * 10}{365d * 24h * 60min}$]。很多年之后block reward就会变得非常小，到那时transaction fee可能就会变成主要奖励。



> 另外一种与之对应的模式是基于账户的模式(account-based ledger)，例如以太坊，这种模式需要显式的记录每个账户有多少个币，不需要显式说明币的来源。



下面是一个区块的信息

![image-20200607213626309](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200607213626.png)

### 挖矿过程的分析

区块定义的部分源码如下:

```c++
class CBlockHeader
{
public:
    // header
    int32_t nVersion;
    uint256 hashPrevBlock; //前一个区块的hash
    uint256 hashMerkleRoot;
    uint32_t nTime;
    uint32_t nBits; //难度值
    uint32_t nNonce; //随机数
```

可以看到`nNonce`域只有32位($2^{32}$个取值)，以现在的挖矿难度很可能将这些值遍历完也找不到符合难度要求的`nNonce`值，所以还需要对其他的域进行调整。发布的区块里有一个特殊的铸币交易，其包含一个CoinBase域可以写入任意值，可以将这个域当做`extra nonce`



挖矿就是不断地尝试nonce，来求解puzzle。每一次尝试可以看作是一次**Bernoulli trial**     (a random experiment with binary outcome)，如果做了很多的Bernoulli trial，每个实验都是随机的，那么这些Bernoulli trial就构成了一个Bernoulli process（a sequence of independent Bernoulli trials）。Bernoulli process的一个性质是**无记忆性 memoryless，即做大量的实验，前面的结果对后面没有影响。** 



对于挖矿来说，每次尝试nonce，成功的可能性很小，需要尝试大量的nonce才可能找到符合要求的，这种情况下，Bernoulli process可以用Poisson process来近似。



出块时间服从指数分布，比特币协议设计通过定期调整挖矿难度，使得平均出块时间维持在10min左右(这个整个系统的出块时间)。具体到每一个矿工，他能够挖到下一个区块的时间，取决于矿工的算力占系统总算力的百分比。指数分布也是无记忆的，这是挖矿公平性的保证。

![image-20200607220944718](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200607220944.png)

### 比特币总量分析

出块奖励每隔21万个区块就要减半

所以 $21w \times 50 + 21w \times 25 + ... = 21w \times 50 \times \underbrace {(1 + \frac{1}{2} + \frac{1}{4} + ...)}_{\frac{1}{1 - \frac{1}{2}} = 2}  = 2100w$

**2100w就是比特币系统中所有比特币的总量，包括已产生的和将要产生的。**

挖矿并不是为了解数学题，比特币求解puzzle的过程， 除了比拼算力，没有其他的实际意义。比特币越来越难被挖到，是因为出块奖励被人为减少了，比特币的稀缺性是人为造成的。虽然挖矿求puzzle本身是没有实际意义，但是挖矿过程对维护比特币系统安全性是很重要的，Bitcoin is secured by mining。挖矿提供了一种凭借算力投票的有效手段，只要大部分算力掌握在诚实的人的手里，系统的安全性就能够得到保证。


### **比特币安全性分析**

假设大部分算力掌握在诚实的矿工的手里，能不能保证写入区块链的交易都是合法的？

不能。挖矿给出的只是概率上的保证，只能说有比较大的概率下一个区块是由一个诚实的矿工发布的，但是不能保证记账权不会落在有恶意的节点手里。如果有恶意的节点获得记账权，他可能会做的事

1. **伪造一笔不合法交易**：比如把别人账上的钱转到自己的账户上，但是由于自己不知道别人的私钥，所以不合法，验证不通过。那么其他诚实节点不会认同该区块，因为包含不合法交易，所以还会接着上一个区块去扩展，那么根据最长合法链，该区块不会获得block reward，而且浪费大量电力，人力。

   ![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200607230423.png)

2. **通过forking attack想把花出去的钱再次花出去**: 比如M转账给A,已经写到区块链中，那么现在M获得记账权，又发布另一个交易，把这个钱转回给自己。新的区块不能写在上次转账的区块后面，因为double spending很明显，只能写在上次转账的前一个区块后面，即forking attack。区块插入的位置是在设计区块的时候就决定的，这种情况下攻击难度很大，有恶意节点获得一次记账权是不够的，还需要不断地获得记账权。防范这种攻击就需要多等几个区块确认(confirmation)，缺省情况下需要6个confirmation，这个时候就认为前面的交易不可篡改，等待时间大概是一个小时左右。

   ![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200607230731.png)

![image-20200607231301170](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200607231301.png)

> **zero confirmation：** 交易已经发出但是还没有写到区块链中
>
> 两个原因:
>
> 1. blockchain 节点缺省设置为接受先监听到的交易
> 2. 购物电商天然有一定的处理时间

3. 恶意节点获得记账权，**故意不写合法的交易**。合法的交易可以被写到下一个区块里，总会有诚实的节点写合法交易。正常情况下也会出现合法交易没有被写到区块中，因为可能某段时间交易数目太多，比特币协议中规定每个区块大小是有限制的，**区块大小不能超过1M字节**，所以如果交易太多那么有些交易只能等到下一区块发布。

4. **selfish mining**： 正常情况下如果挖到区块会及时发布，以免别人挖到后自己的区块无效。但是在selfish mining中，挖到区块先不发布，隐藏一条链，等待超过最长合法链时发布。

   ​          目的:

    1  ) forking attack的一种手段，但是恶意节点需要超过51%的算力，难以实现
    2 ) 为了赚取正常的出块奖励，挖到第一时间不发布，那么其他人还会接着上一个区块挖，自己延着已挖到区块的挖，减少该区块的竞争。如果自己已经挖到第二个区块，当其他人宣称挖到第一个区块之后，自己把手里的两个一起发布，成为最长合法链。这种做法风险大，要确定别人挖出第一个区块时，自己能够挖出第二个，否则当别人挖出并发布时，自己手里只有一个，这时候是等长链，只能去竞争。