---
title: "ETH15 以太坊中的交易树和收据树"
date: 2023-05-28T13:51:21+08:00
draft: false
image: ""
categories: 
tag:
---


> 整理自 [北京大学肖臻老师《区块链技术与应用》公开课](https://www.bilibili.com/video/BV1Vt411X7JF?from=search&seid=14488407572640514229)



每次发布一个区块，区块中所包含的交易会组织成一棵交易树。每个交易执行完之后会形成一个收据，记录交易的相关信息，交易树与收据树上的节点是一一对应的。增加收据树是考虑到以太坊的智能合约执行过程比较复杂，所以通过增加收据树的结构有利于快速查询一些执行结果。交易树和收据树都是MPT，比特币中的交易树是普通的merkle tree。 

### 三种树的区别

交易树和收据树都是只把当前发布的区块里的交易组织起来，而状态树是把系统中所有账户的状态都要包含进去，不管这些账户和当前这些交易有没有关系。多个区块的状态树是共享节点的，每次新发布一个区块的时候，只有区块中的交易改变了状态的节点需要新建分支，其他节点沿用原状态树的节点。相比之下，每个区块的交易树和收据树都是独立的，不会共享节点。

### 交易树和收据树的作用

1. 提供merkle proof，证明某个交易的执行结果
2. 以太坊支持更复杂的查询操作，比如想找到过去十天中和某个智能合约有关的交易，一种做法是把过去十天产生的所有区块都扫描一遍，看其中哪些交易是和智能合约相关。该方法复杂度高，而且对于轻节点来说，没有交易列表，没办法通过扫描所有交易列表的方法来找到符合条件的交易。还有就是查找过去十天符合某种类型的交易事件(如众筹事件、发行新币事件等)，这些需要高效的方法才能支持。
   而以太坊中引用了**布隆过滤器**(bloom filter)的数据结构，每个交易执行完之后会形成一个收据，收据里面包含一个bloom filter，记录交易的类型、地址等信息，发布的区块的块头中有一个总的bloom filter，是区块里所有bloom filter的一个并集。所以如果要找到过去十天中和某个智能合约有关的交易，先查哪个区块的块头里的bloom filter有我要的交易的类型。如果块头里没有，那么这个区块就不是我们要找的。如果块头的bloom filter里有的话，再去查找区块里面包含的交易所对应的收据树里面的那些bloom filter，看看哪个有，也可能都没有。如果有再找到对应的交易确认。这样的好处是通过bloom filter的结构，能够快速过滤掉大量无关的区块。

> **布隆过滤器**
>
> 该数据结构支持比较高效的查找某个元素是否在一个比较大的集合中。比如一个集合中有很多元素，想知道某个指定元素是否在集合中。bloom filter给包含很多元素的集合计算出一个紧凑的摘要，比如一个128bits的向量，向量初始的时候都是0，有一个哈希函数H，把每个元素映射到向量中的某个位置，该位置的元素就从0变成1。等到所有元素都处理完，得到的向量就是原集合的一个摘要，该摘要比集合小很多。如果要判断一个元素是否在集合中，集合本身可能不被保存，用哈希函数对元素取哈希值，如果取完之后发现映射到一个0的位置，说明该元素一定不在集合中，如果映射到一个1的位置，该元素可能在集合中，也可能不在集合中，出现了哈希碰撞。bloom filter可能可能会误报，但不会漏报。另外bloom filter不支持删除操作。

### 交易驱动的状态机

以太坊的运行过程可以看作是一个交易驱动的状态机(transaction-driven state machine)。状态机的状态就是所有账户的状态(状态树包含的内容)，交易是每次发布的区块里包含的交易，通过执行这些交易会驱动系统从当前的状态转移到下一个状态。

比特币也可以认为是一个交易驱动的状态机，比特币中状态是UTXO，每次新发布一个区块，会从UTXO中用掉一些输出，又会增加一些新的输出，所以发布的区块会驱动状态机从当前状态转移到下一个状态。

两个状态机一个**共同点**就是状态转移都必须是确定性的，对一个给定的当前状态，一组给定的交易，能够确定性的转移到下一个状态(因为所有的全节点/矿工都要执行同样的状态转移)。



### 问题

1. 某人发布一个转账交易: A-->B，某个节点收到该交易，有没有可能B的地址以前从没出现过?

   可能。创建账户时不需要通知其他人，只有在第一次收到钱时其他账户才会知道该账户的存在。

2. 现行状态树包含全部账户的状态，能不能改成只包含新发布区块的交易中涉及到的账户的状态?

   不能。查找账户状态不方便，得往前面的区块中找。如交易A-->B，需要往前找到A最近的一个交易，如果A很长一段时间内没有交易，那么就需要向前找很长。而且更严重的问题是如果B是新增的账户，那么直到找到创世块才能知道B是新增的账户。

