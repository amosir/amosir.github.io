---
title: "BTC03 比特币的共识协议"
date: 2020-06-09T13:45:48+08:00
draft: true
image: ""
categories: 
tag:
---

> 整理自 [北京大学肖臻老师《区块链技术与应用》公开课](https://www.bilibili.com/video/BV1Vt411X7JF?from=search&seid=14488407572640514229)

### 央行CB如何发行数字货币?

1. 方案一：asymmetric encryption algorithm
2. 方案二：每个数字货币上有一个编号，然后用数据库记录每个编号的货币在谁手里，记录前检查该编号的货币是否在支付人手里

方案一存在的问题是: 数字货币实际是一个文件，是可以复制的，从而导致**double spending attack**(双花攻击)；

方案二存在的问题是: 中心化方案

### 去中心化方案要解决的问题?

1. 数字货币的发行: 谁发行？什么时候发行？该发行多少？

   通过挖矿决定

2. 怎么验证交易的有效性，防范双花攻击?

   需要维护一个数据结构，记录某币是否被消费，被谁消费过。只是**这个数据结构由所有用户共同维护**，而不是中心化机构维护，这个数据结构就是**区块链**。

   ![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200607170511.png)

   这个数据结构中有两类哈希指针: 即连接区块的哈希指针和指向币来源的哈希指针

> 区块的结构

|                     Block header                     |         Block body          |
| :--------------------------------------------------: | :-------------------------: |
|               --version 比特币哪个版本               | --transaction list 交易列表 |
|  --hash of previous block header 前一个区块头的哈希  |                             |
| --root hash of merkle tree 整个merkle tree的根哈希值 |                             |
|             --target 挖矿的难度目标阈值              |                             |
|                    --nonce 随机数                    |                             |
|                  --timestamp 时间戳                  |                             |

当前区块保存前一区块的哈希值，这个哈希值实际上只是对block header求哈希，类似下图

![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200607180245.png)



比特币系统中每个交易都包含输入和输出两部分，**输入部分要说明币的来源以及付款人的公钥，输出部分要给出收款人的公钥的哈希。**

### 几个问题

**转账交易中A(支付人)需要知道B(收款人)的什么信息?**

A需要知道B的地址，比特币中收款地址是通过公钥推算出来的，地址相当于银行账号，而公钥是可以公开的，不需要保密。



**转账交易中B(收款人)需要知道A(支付人)的什么信息?**

B需要知道A的公钥，即知道A的身份，所有节点都需要知道A的公钥用来验签。



**如果有B'宣称自己是A，使用A的公钥发起交易，该怎么防治?**

A--->B交易中A的公钥要与币的来源中A的公钥的哈希对得上。如果此时有B'伪造一对公私钥，冒充A给B转账，虽然B'的公钥能够验签成功，但是该公钥与币的来源中公钥的哈希值对不上，所以无法伪造交易。



### 分布式共识

数据怎样被写入区块链中？

每个节点都可以发布交易，交易广播给所有节点，有些交易合法而有些交易非法。那么谁来决定哪些交易应该被写到下一个区块中？

按照什么样的顺序写？

---



数据要写入区块链就要先取得分布式共识(**distributed consensus**)



#### **FLP impossibility result**

在一个异步系统中（网络传输延迟无上限）,即使只有一个成员有问题(faulty)，也不可能取得共识。



#### **CAP Theorem**

Consisency 一致性、Avalilability 可用性、Partition tolerance 分区容错性；

该理论是说分布式系统中最多满足上面性质中的两个，不可能都满足。

分布式共识中一个重要的协议是 Paxos，该协议保证了Consisency



#### **比特币中的共识协议**

该公式协议要解决的问题是: 有些节点是恶意的。(假设系统中大多数节点是好的，有恶意的是少数。)

> 既然大多数节点是好的，那能不能通过投票解决?

投票可能会出现以下问题:

1. 节点本身有恶意的，不断地提出非法候选区块，大家不停地进行投票，造成时间浪费在投票上
2. 个别节点不投票，行政不作为
3. 效率问题。网络延迟，投票等待时间等
4. membership问题。确定谁有投票权，不是谁都可以加入，比如联盟链协议 hyperledger facric，只有大公司可以加入，这种情况下基于投票是可行的。但是比特币系统中创建账户很容易，不需要外部批准。恶意节点可以不停地产生账号，占据控制权，操纵投票结果，这就是**女巫攻击 sybil attack**。所以简单、直接的投票在比特币中不可行。



**算力投票机制**: 

比特币中投票不是按照账户数目，而是按照算力投票。每个节点都可以在本地组装一个候选区块，把认为合法交易放在区块中，然后开始尝试各种nonce值，使得H(block header) <= target。如果某个节点找到符合要求的nonce，就会获得记账权(即在区块链中写入下一个区块的权利)，只有找到nonce，获得记账权，才有权发布下一区块，其他节点收到区块，验证合法性。

但是，并不是说一个区块只要经过检查，header和body中的交易列表都符合要求，就一定会被接受。如下图:

![](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200607184305.png)

如图，A-->A'的区块中包含的交易都是合法的，但是插在了区块链中间。比如A先把钱转给了B，又把钱转给了自己A'，这个交易是合法的，不属于double spending（验证double spending是从当前区块到币的来源之间，中间的区块是否有花过这些币）。A-->A'是想把A-->B的交易回滚掉，把钱再转给自己，虽然交易合法，但是不在最长合法链中，上面的链才是最长合法链。所以在比特币中，接收的区块应该是在最长合法链中。A-->A'例子其实是**分叉攻击 forking attack**，通过往区块链中间位置插入区块，来回滚某个已经发生过的交易。

正常情况下也会出现分叉，比如两个节点同时获得记账权，这时候会出现两个等长的分叉，如图中后半部分的分叉，此时这两个都属于最长合法链。如果出现系统中两个节点同时发布区块，这种等长的、临时性的区块会维持一段时间，直到某一个分叉最后胜出（被扩展），另一个被丢弃，叫做orphan block。



**获取记账权的好处**:

1. 获得记账权的节点本身有一定的权利，可以决定哪些交易被写进下一个区块，但不是主要动力，凡是合法交易都应该能被写入区块中。
2. 出块奖励。获得记账权的节点，在发布的区块里，可以有一个特殊交易，即**铸币交易 coinbase transaction**。在这个交易中可以发布一定数量的比特币，这就是开始提到的去中心化要解决的第一个问题：谁来发行比特币。coinbase transaction是比特币系统中产生新的比特币的唯一方法，造币数量50BTC-->25BTC-->12.5BTC，每21万个区块出块奖励都要减半。orphan block中的出块奖励无效。

> 比特币系统中要取得的分布式共识是去中心化账本中的内容，只有获得记账权的节点才能往里写东西，想要获得记账权，就要解puzzle，即使H(block header) <= target。puzzle friendly的性质保证求解puzzle的过程没有捷径，只能一个个nonce去试。算力大的节点，获得记账权的概率也大，这就是比特币中投票的特殊性，看每秒钟能试的nonce的数目，也就是hash rate，它决定投票权重，hash rate越高，获得记账权、得到出块奖励的概率也就越大。
>

这样可以可以防范sybil attack，因为投票靠算力，与多少账户无关，创建的账户多，不会使hash rate增加，投票权重没变。

比特币中争夺记账权的过程也叫**挖矿mining**。把比特币比作数字黄金 digital gold，矿工 miner就是争夺记账权的节点，而区块就是通过挖矿挖出来的。



