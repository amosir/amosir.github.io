---
title: "ETH16 GHOST协议"
date: 2023-05-28T13:50:57+08:00
draft: true
image: ""
categories: 
tag:
---

> 整理自 [北京大学肖臻老师《区块链技术与应用》公开课](https://www.bilibili.com/video/BV1Vt411X7JF?from=search&seid=14488407572640514229)

### 背景

比特币和以太坊都运行在应用层，底层是p2p的overlay network，区块在网络上传播到其他节点需要十几秒时间。对于比特币十分钟的出块时间来说，这个时间足够一个区块传播到其他节点，但即使这样也有可能出现两个矿工同时获得记账权，同时发布区块，这种情况会带来临时性的分叉。对于以太坊来说，因为出块时间只有十几秒，这种临时性的分叉就会变成常态，而且分叉的数目也会更多。

以上情况对于共识协议设计来说是挑战。

比特币的情况是只有在最长合法链上的区块包含的出块奖励是有效的，其他分叉链上的出块奖励最后是作废的(如下图)，因为比特币出现临时性分叉的情况不是很多，所以该规定可以接受。
![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200613101720.png)

但是对于以太坊来说，如果用同样的处理方式，意味着矿工挖到的区块有很大概率是白挖的，挖出的区块因为系统中分叉很多，很有可能不会成为最长合法链，该区块就作废了，对挖到矿的矿工来说不公平，尤其是对个人矿工来说情况更严重。 之前说过挖矿的两个趋势：挖矿设备的专业化以及大型矿池的出现在以太坊也一样。之所以说对于个体矿工更不公平，是因为正常情况希望的是矿池得到的收益应该与所占的算力比例是一致的。假设矿池的算力是系统中总算力的30%，那么得到的收益也应该是系统的30%，这样才算是公平。但是如果共识协议设置不好，有可能矿池得到的收益超过算力的比例(如下图)。假设上下两个是个体矿工挖出来的区块，中间是大矿池挖出来的区块，矿池会延着自己的区块继续挖，个体矿工只能希望别人延着自己的区块继续挖，因为自己的算力太弱了。但是对于其他矿工来说，没什么理由要延着个体矿工的区块继续挖，假设矿池挖到区块的概率是30%，但是成为最长合法链的概率要更高，出现mining centralization，实际情况可能更糟。大矿池发布出来的区块可能会更早的被其他节点收到。从历史经验来看，大矿池所在的分叉，更有可能成为最长合法链，这也就促使别的矿工延着该分叉继续挖，因为延着别的分叉继续挖的话可能就白挖了，这样就使得大矿池出现一个恶性循环，越是大型矿池得到的收益越大， mining centralization就更严重，出现centralization bias，中心化带来的不成比例的优势。如果以太坊沿用比特币的共识机制就会出现上述问题。
![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200613101825.png)

### GHOST协议

以太坊采用的是**基于ghost协议的共识机制**，以太坊出现以前就已经有了ghost协议，以太坊对该协议做了一些修改。ghost协议的**核心思想**是<u>当你挖到矿，发布了一个区块，如果最后区块作废了，也会给你一些出块奖励，这种区块叫做uncle block，相当于最长合法链上的区块的叔父区块</u>。
![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200613101846.png)

如上图，当最长合法链上的区块A发布时，可以包含叔父区块B，这样叔父区块B会得到7/8倍的出块奖励(即如果正常情况下出块奖励为5，那么B的奖励就是$\frac{7}{8} \times 5$)。当发布的区块A包含叔父区块B时，可以得到1/32倍的额外的出块奖励，本身还能得到完整的一个出块奖励。一个区块最多可以包含两个叔父区块。这样设计有利于鼓励系统中出现分叉后及时进行合并。



### 问题

1.如果出现第三个叔父区块，但是没有被包含进去怎么办?

2.挖区块时不知道叔父区块的存在?

3.如果知道某叔父区块的存在但是故意不包含?



叔父定义的扩展：
如下图，Ghost规定，B依然是A2，A3的叔父区块。这样的好处是如果有A故意不包含B的情况出现，那么后面总会有区块把B作为叔父区块包含进去。

![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200613101908.png)

> 叔父区块不一定是当代叔父，可能是隔着几代的叔父，但是隔多少代呢？ 



如下图，A是当前区块的当代叔父，可以得到7/8的出块奖励，B是当前区块的上一代叔父，可以得到6/8的奖励，以此类推......直到F区块可以得到2/8的出块奖励，再往前的区块就不算是当前区块的叔父区块，得不到出块奖励。

**叔父区块不能超过6代**。叔父区块的定义是必须和当前这个区块在7代以内有共同的主线，并且7代以内出块奖励是递减的。合法的叔父只有6个辈分。如果不限制叔父的辈分，那么对于全节点来说维护的状态就太多了。发布的区块包含的叔父区块，其他节点也是要验证的。另外7代以内出块奖励递减的设计有利于出现分叉尽早的进行合并，出现分叉马上合并的时候得到的出块奖励是最多的，隔了好多代之后得到的出块奖励越来越少，直到得不到出块奖励。

但是对于当前区块来说，无论包括哪一代的叔父区块，得到的额外出块奖励都是1/32。
![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200613101931.png)

该协议解决的是系统中出现的临时性分叉，包括比特币中的最长合法链解决的也是临时性分叉。如果分叉是其他原因造成的，比如对运行的区块链协议有不同意见，那么该协议是解决不了的。



### 挖矿奖励

比特币发布一个区块得到两部分奖励，一部分是出块奖励(静态奖励)，一部分是交易费(动态奖励)。以太坊中类似，也有静态奖励(出块奖励)，动态奖励(gas fee)。一个区块包含智能合约，执行智能合约时可以得到gas fee。叔父区块得到的7/8倍的区块奖励只限于出块奖励，得不到gas fee。但是问题不大，因为gas fee占的比例是很小的，大部分都是静态奖励。比特币中的出块奖励会定期减半，等减到0的时候交易费就成为主流。但是以太坊中没有规定定期要把区块奖励减半。比特币中是为了人为制造稀缺性，以太坊出块奖励从5个以太币降到3个以太币，实际上是与挖矿难度的调整有关。

### 叔父区块的交易

叔父区块中的交易不执行，因为主链上的父区块和叔父区块可能包含冲突交易。包含叔父区块时只要验证叔父区块是否是合法区块(是不是符合挖矿难度)，只检查header就可以。至于区块里包含的交易是不是合法的是不检查的，叔父区块的交易也不会执行。

> 上述的叔父区块都是分叉后的第一个区块，那第一个区块后面的区块比如F，算不算当前区块的叔父区块？为什么不把下面一条链当做叔父区块，给每个区块一点奖励？

![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200613101958.png)

如果这样的话，那么分叉攻击成本降低。在区块6上有一笔交易A->B，在经历多个区块确认后，A发动分叉攻击A->A'，如果分叉攻击成功需要下面链比上面链长，这个代价比较大，如果没有比上面长那么下面的链都白挖了，这是分叉攻击的代价。但是如果把下面的链当做是叔父区块，每个区块都给一点奖励，那么分叉攻击的风险就大幅度下降，攻击成功就会把交易回滚，攻击失败也会得到出块奖励。所以只有分叉后的第一个区块才能得到uncle reward，后面的都不可以。
