---
title: "ETH18 以太坊的挖矿难度调整算法"
date: 2023-05-28T13:51:59+08:00
draft: false
image: ""
categories: 
tag:
---

> 整理自 [北京大学肖臻老师《区块链技术与应用》公开课](https://www.bilibili.com/video/BV1Vt411X7JF?from=search&seid=14488407572640514229)

区块难度调整公式为:

<img src="https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200613174310.png" alt="" style="zoom:50%;" />

参数说明:

* $H_i$是当前区块的序号，D(H)是当前区块的难度，由两部分构成: **基础部分**($P(H)_{H_d} + x \times \zeta_2$) 和 **难度炸弹部分**($\epsilon $)。
* $P(H)_{H_d}$是父区块的难度，每个区块的难度都是在父区块难度的基础上进行调整
* $x \times \zeta_2$用于自适应调节出块难度，维持稳定的出块速度
* 难度炸弹部分用于向权益证明过渡
* 基础部分有下界，即$D_0$



下面是自适应出块难度调整的相关参数:



$$x \equiv \bigg \lfloor \frac{P(H)_{H_d}}{2048} \bigg \rfloor$$

$$\zeta_2 \equiv max(y - \bigg \lfloor \frac{H_s - P(H)_{H_s}}{9} \bigg \rfloor , -99)$$



* $x$是调整的单位，$\zeta_2$是调整的系数
* $y$和父区块的uncle数有关。如果父区块包含uncle，则$y$为2，否则$y$为1。父区块包含uncle时难度会大一个单位，因为包含uncle时新发布的货币量大，需要适当提高难度以保持货币发行量稳定
* 难度降低的下界设置为-99

关于$y - \bigg \lfloor \frac{H_s - P(H)_{H_s}}{9} \bigg \rfloor$这个式子:

* $H_s$是本区块的时间戳，$P(H)_{H_s}$是父区块的时间戳，都以秒为单位，并规定$H_s \gt P(H)_{ H_s }$。这部分是稳定出块速度最重要的部分，如果出块时间过短则增大难度，如果出块时间过长则减小难度。
* 以父区块不包含uncle为例
  * 出块时间在[1,8]之间，出块时间过短，增大一个单位难度
  * 出块时间在[9,17]之间，出块时间可以接受，难度不变
  * 出块时间在[18,26]之间，出块时间过长，减小一个单位难度



**难度炸弹**
$$
\epsilon \equiv \bigg \lfloor 2 ^ {\lfloor {H_{i}^ {\prime} \div 100000} \rfloor - 2} \bigg \rfloor
$$

$$
H_i^{\prime} \equiv max(H_i - 3000000,0)
$$



以太坊的工作机制要从工作量证明转移到权益证明，而权益证明不挖矿，那么就带来一个问题，那些已经在挖矿设备上投入了大量资金的矿工可能会联合抵制该转换，原本工作量证明转入到权益证明需要硬分叉来实现，相当于改了共识协议，为了避免以太坊出现两条并行的链的情况，所以以太坊在设计难度调整公式的时候加了一个难度炸弹。



开始设计难度炸弹的时候没有下面减3000000的部分，只有上面用当前区块号计算难度炸弹的部分。当前区块号除以100000向下取整，然后作为2的指数。难度炸弹的取值是呈指数形式的增长的，指数函数的特点是早期以太坊刚刚上线不久的时候，区块号都比较小，所以难度炸弹这部分算出来的值是很小的，基本上可以忽略不计，难度主要还是由基础部分来决定，或者说是由系统中出块时间来决定。当区块号变大时，难度炸弹的威力显现，指数函数增长到后期速度是非常恐怖的。等到难度炸弹的威力开始发挥的时候，也正好是以太坊需要从工作量证明转入权益证明的时候。那时候挖矿越来越难，大家也就愿意转入权益证明，不转的话也很难挖出矿。



但是实际情况是基于权益证明的共识机制设计出来有很多问题要解决，这样就导致时间点一再推迟，然后出现的情况就是挖矿越来越难，因为难度炸弹的威力已经显现出来了，但是还是要继续挖矿，没有其他方式达成共识。最后以太坊在EIP(Ethereum Improvment Protocal)中决定计算难度炸弹的时候要把区块号回退3000000个区块来计算(就是下面部分用真实的区块号减去3000000的值，然后算难度炸弹的时候用该值去算，给权益证明的上限争取一些时间。


