---
title: "BTC08 分叉"
date: 2023-05-28T13:47:48+08:00
draft: true
image: ""
categories: 
tag:
---

> 整理自 [北京大学肖臻老师《区块链技术与应用》公开课](https://www.bilibili.com/video/BV1Vt411X7JF?from=search&seid=14488407572640514229)

### 分叉

原来是一条链，现在分成两条链。

造成分叉的原因有很多，比如挖矿时两个节点几乎同时发布，会出现临时性的分叉，这样的分叉叫做state fork，由于对比特币当前的状态有意见分歧导致的分叉。分叉攻击 forking attack也属于state fork，只不过这个意见分歧是人为故意造成的，称为deliberate fork。

还有一种产生分叉的情况是比特币的协议发生改变，修改比特币协议需要软件升级。在去中心化的系统里，升级软件的时候，没有办法保证所有的节点同时都升级软件。假设大部分节点升级了软件，少数节点没有升级，这种对比特币协议造成分歧，用不同版本协议造成的分叉，称为protocal fork。根据对协议修改的内容不同，又可以进一步分成硬分叉 hard fork和软分叉soft fork。

### 硬分叉

如果对比特币协议增加一些新特性，扩展一些新的功能，那些没有升级软件的旧节点就不会认可这些新特性，认为这些特性是非法的，就会导致分叉。

例：block size limit：1M -->4M，系统中拥有大多数hash算力的节点认可4M，少数没有升级软件的旧节点不认可4M，还是认可1M，就会造成永久性社区分裂，只要旧节点不升级软件，分叉就一直存在，所以是硬分叉 hard fork。
![img](https://gitee.com//tiansir-wg/blogimg/raw/master/imgs/20200609120035.png)

出现hard fork之后，就会有两条平行运行的链，彼此之间有各自的加密货币，变成社区分裂。分叉之前的币，应该是两条链都认可。



### 软分叉

协议中加一些限制，使得原本合法的区块在新协议中不再合法。

例：block size limit：1M -->0.5M，系统不会有永久性分叉，只是旧节点挖出的区块都白挖。

![img](media/img.png)

**可能出现软分叉的情况:**

1. 给某些目前协议中没有规定的域增加新的含义或赋予新的规则。例如: coinbase tx中有一个域叫作coinbase域，这个域究竟用来做什么没人规定也没人检查，前8字节可以作为挖矿时的extra nonce，block header中的nonce只有4bytes，最多有$2^{32}$个可能性，搜索空间不够大。加上coinbase前8个字节，就有$2^{96}$个可能性，作为目前的挖矿难度足够了。对于coinbase域后面的字节，有人提出可以作为UTXO集合的root hash，这样就会造成soft fork，因为新节点发布的区块旧节点认可(旧节点不在乎coinbase里面有什么内容)，但是旧节点发布的区块新节点不认可，因为coinbase域没有按照要求去写。

2. P2SH(Pay to Script Hash)。这个功能在最初的比特币版本里是没有的，而是后来通过软分叉的方法加进去的。就是说支付的时候不是付给一个公钥的哈希，而是付给一个赎回脚本( redeem script)的哈希。

   花钱的时候要把这个交易的输入脚本和前一个币的来源交易的输出脚本拼在一起执行。执行的时候验证分为两步：第一步验证输入脚本中给出的redeem script和前面输出脚本的哈希值是对得上的，证明输入脚本提供的script是正确的。第二步再去执行这个redeem script，来验证输入脚本里给出的签名是合法的，完成两阶段验证。 

   旧节点只会做第一阶段的验证，新节点才会做两个阶段的验证，所以旧节点认为合法的交易新节点认为非法，新节点认为合法的交易旧节点肯定认为合法。

**总结**:

**soft fork特点：只要系统中拥有大部分算力的节点更新软件，就不会出现永久性分叉，可能会出现一些临时性分叉。**

**hard fork特点：必须是系统中所有节点都更新软件，才不会出现永久性分叉。只要有小部分节点不更新，就会出现永久性分叉。**

